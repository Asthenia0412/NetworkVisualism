<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QUIC协议交互式模拟器</title>
    <style>
        :root {
            --quic-blue: #4285F4;
            --quic-green: #34A853;
            --quic-red: #EA4335;
            --quic-yellow: #FBBC05;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            background-color: #f5f7fa;
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        .container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .control-panel {
            flex: 1;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .visualization {
            flex: 2;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .quic-diagram {
            width: 100%;
            height: 400px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        .client-box, .server-box {
            position: absolute;
            width: 150px;
            height: 180px;
            border: 2px solid var(--quic-blue);
            border-radius: 8px;
            padding: 10px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .client-box {
            left: 50px;
            top: 50px;
        }
        .server-box {
            right: 50px;
            top: 50px;
        }
        .status-indicator {
            font-size: 0.9em;
            margin-top: 10px;
            padding: 5px;
            border-radius: 4px;
            background-color: #e8f4fc;
        }
        .connection-path {
            position: absolute;
            height: 2px;
            background-color: #95a5a6;
            left: 200px;
            right: 200px;
            top: 120px;
            opacity: 0.3;
        }
        .packet {
            position: absolute;
            width: 80px;
            height: 30px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            font-weight: bold;
            color: white;
            text-shadow: 
                0 0 3px #000,
                0 0 5px #000;
            transition: all 1.5s ease;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .packet.handshake {
            background-color: #2E7D32;
        }
        .packet.stream {
            background-color: #1565C0;
        }
        .packet.ack {
            background-color: #FFC107;
            color: #212121;
            text-shadow: 
                0 0 3px #fff,
                0 0 5px #fff;
        }
        .packet.crypto {
            background-color: #5E35B1;
        }
        .packet.lost {
            background-color: #C62828;
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }
        .packet-info {
            position: absolute;
            width: 200px;
            padding: 5px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.7em;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 20;
            pointer-events: none;
        }
        .packet:hover .packet-info {
            opacity: 1;
        }
        .drawing-line {
            position: absolute;
            height: 2px;
            background-color: #3498db;
            transform-origin: left center;
            transform: scaleX(0);
            transition: transform 1.5s ease;
            z-index: 5;
        }
        .drawing-line.active {
            transform: scaleX(1);
        }
        .drawing-line.handshake {
            background-color: var(--quic-green);
        }
        .drawing-line.stream {
            background-color: var(--quic-blue);
        }
        .drawing-line.ack {
            background-color: var(--quic-yellow);
        }
        .drawing-line.lost {
            background-color: var(--quic-red);
        }
        .param-group {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--quic-blue);
        }
        .param-group h3 {
            margin-top: 0;
            color: var(--quic-blue);
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        input[type="range"], select {
            width: 100%;
            margin-bottom: 5px;
            padding: 5px;
        }
        .value-display {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: #7f8c8d;
        }
        .param-description {
            font-size: 0.85em;
            color: #666;
            margin-top: 8px;
            line-height: 1.4;
        }
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        button {
            background-color: var(--quic-blue);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            flex: 1;
            min-width: 120px;
        }
        button:hover {
            background-color: #3367D6;
        }
        button.secondary {
            background-color: #95a5a6;
        }
        button.secondary:hover {
            background-color: #7f8c8d;
        }
        .concept-section {
            margin-top: 30px;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .concept-card {
            background-color: #f0f8ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid var(--quic-blue);
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9em;
        }
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .data-table th {
            background-color: #f2f2f2;
        }
        .data-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .data-table tr.highlight {
            background-color: #e8f4fc;
        }
        .data-table tr.error {
            background-color: #ffebee;
        }
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8em;
            font-weight: normal;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .error-message {
            color: var(--quic-red);
            font-weight: bold;
            margin-top: 10px;
        }
        .warning-message {
            color: var(--quic-yellow);
            font-weight: bold;
            margin-top: 10px;
        }
        .connection-id {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 5px 10px;
            border-radius: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-family: monospace;
        }
        .stream-indicator {
            position: absolute;
            width: 100%;
            height: 20px;
            bottom: 10px;
            display: flex;
            justify-content: center;
            gap: 5px;
        }
        .stream-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ddd;
        }
        .stream-dot.active {
            background: var(--quic-blue);
        }
    </style>
</head>
<body>
    <h1>QUIC协议交互式模拟器</h1>
    <p>通过这个交互式工具，直观理解QUIC协议的核心特性，包括0-RTT握手、多路复用、连接迁移等高级功能。</p>
    
    <div class="container">
        <div class="control-panel">
            <h2>控制面板</h2>
            
            <div class="param-group">
                <h3>模拟参数</h3>
                
                <label for="connectionId">
                    连接ID (CID)
                    <span class="tooltip">?
                        <span class="tooltiptext">QUIC连接的唯一标识符，支持连接迁移</span>
                    </span>
                </label>
                <input type="text" id="connectionId" value="0x7F3A9B2C" readonly>
                
                <label for="streamCount">
                    初始流数量
                    <span class="tooltip">?
                        <span class="tooltiptext">QUIC支持的多路复用流数量</span>
                    </span>
                </label>
                <input type="range" id="streamCount" min="1" max="10" value="3" step="1">
                <div class="value-display">
                    <span>1</span>
                    <span id="streamCountValue">3</span>
                    <span>10</span>
                </div>
            </div>
            
            <div class="param-group">
                <h3>场景模拟</h3>
                
                <label for="quicScenario">
                    选择模拟场景
                    <span class="tooltip">?
                        <span class="tooltiptext">选择要演示的QUIC特性场景</span>
                    </span>
                </label>
                <select id="quicScenario">
                    <option value="zeroRtt">0-RTT快速握手</option>
                    <option value="multiplexing">多路复用流</option>
                    <option value="migration">连接迁移</option>
                    <option value="packetLoss">丢包恢复</option>
                    <option value="congestion">拥塞控制</option>
                </select>
                
                <div class="param-description">
                    每个场景将展示QUIC的不同核心特性
                </div>
            </div>
            
            <div class="button-group">
                <button id="startSimulation">开始模拟</button>
                <button id="stepSimulation" class="secondary">单步执行</button>
                <button id="resetSimulation" class="secondary">重置</button>
                <button id="addStream" class="secondary">添加数据流</button>
                <button id="dropPacket" class="secondary">模拟丢包</button>
            </div>
            
            <div id="errorMessage" class="error-message"></div>
            <div id="warningMessage" class="warning-message"></div>
        </div>
        
        <div class="visualization">
            <h2>QUIC协议可视化</h2>
            
            <div class="quic-diagram" id="quicDiagram">
                <div class="connection-path"></div>
                <div class="connection-id">Connection ID: <span id="cidDisplay">0x7F3A9B2C</span></div>
                <div class="client-box">
                    <strong>客户端</strong>
                    <div class="status-indicator" id="clientStatus">状态: 新建</div>
                    <div id="clientStreams">活动流: 0</div>
                </div>
                <div class="server-box">
                    <strong>服务端</strong>
                    <div class="status-indicator" id="serverStatus">状态: 等待连接</div>
                    <div id="serverStreams">活动流: 0</div>
                </div>
                <div class="stream-indicator">
                    <div class="stream-dot"></div>
                    <div class="stream-dot"></div>
                    <div class="stream-dot"></div>
                </div>
                <!-- 动态添加的绘制线条和数据包 -->
            </div>
            
            <h3>协议交互详情</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>时间</th>
                        <th>数据包类型</th>
                        <th>方向</th>
                        <th>流ID</th>
                        <th>加密级别</th>
                        <th>状态变化</th>
                        <th>说明</th>
                    </tr>
                </thead>
                <tbody id="protocolTableBody">
                    <!-- 数据将通过JavaScript动态填充 -->
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="concept-section">
        <h2>QUIC核心特性解析</h2>
        
        <div class="concept-card">
            <h3>1. 0-RTT快速握手</h3>
            <ul>
                <li><strong>工作原理</strong>：
                    <ol>
                        <li>首次连接完成TLS 1.3完整握手</li>
                        <li>服务端颁发会话凭证(Session Ticket)</li>
                        <li>后续连接使用凭证恢复会话</li>
                    </ol>
                </li>
                <li><strong>加密流程</strong>：
                    <table class="data-table">
                        <tr>
                            <th>握手类型</th>
                            <th>加密级别</th>
                            <th>耗时</th>
                        </tr>
                        <tr>
                            <td>完整握手</td>
                            <td>1-RTT</td>
                            <td>1个往返</td>
                        </tr>
                        <tr>
                            <td>会话恢复</td>
                            <td>0-RTT</td>
                            <td>0个往返</td>
                        </tr>
                    </table>
                </li>
                <li><strong>安全限制</strong>：0-RTT数据不能是幂等操作，防止重放攻击</li>
            </ul>
        </div>
    </div>

    <script>
        // QUIC模拟器核心逻辑
        class QuicSimulator {
            constructor() {
                this.state = {
                    step: 0,
                    scenario: 'zeroRtt',
                    connectionId: this.generateConnectionId(),
                    streams: [],
                    packets: [],
                    clientState: '新建',
                    serverState: '等待连接',
                    activeStreams: 0,
                    isSimulating: false,
                    simulationInterval: null
                };
                
                this.setupControls();
                this.updateDisplay();
            }
            
            generateConnectionId() {
                const randomHex = () => Math.floor(Math.random() * 16).toString(16);
                return '0x' + Array.from({length: 8}, randomHex).join('').toUpperCase();
            }
            
            setupControls() {
                // 绑定UI控件
                document.getElementById('startSimulation').addEventListener('click', () => this.startSimulation());
                document.getElementById('stepSimulation').addEventListener('click', () => this.stepSimulation());
                document.getElementById('resetSimulation').addEventListener('click', () => this.resetSimulation());
                document.getElementById('addStream').addEventListener('click', () => this.addStream());
                document.getElementById('dropPacket').addEventListener('click', () => this.simulatePacketLoss());
                
                // 参数绑定
                document.getElementById('quicScenario').addEventListener('change', (e) => {
                    this.state.scenario = e.target.value;
                    this.resetSimulation();
                });
                
                document.getElementById('streamCount').addEventListener('input', (e) => {
                    document.getElementById('streamCountValue').textContent = e.target.value;
                    this.updateStreamIndicators(e.target.value);
                });
            }
            
            updateDisplay() {
                // 更新状态显示
                document.getElementById('cidDisplay').textContent = this.state.connectionId;
                document.getElementById('clientStatus').textContent = `状态: ${this.state.clientState}`;
                document.getElementById('serverStatus').textContent = `状态: ${this.state.serverState}`;
                document.getElementById('clientStreams').textContent = `活动流: ${this.state.activeStreams}`;
                document.getElementById('serverStreams').textContent = `活动流: ${this.state.activeStreams}`;
                
                // 清空表格
                document.getElementById('protocolTableBody').innerHTML = '';
            }
            
            updateStreamIndicators(count) {
                const dots = document.querySelectorAll('.stream-dot');
                dots.forEach((dot, index) => {
                    dot.classList.toggle('active', index < count);
                });
            }
            
            startSimulation() {
                if (this.state.isSimulating) return;
                
                this.state.isSimulating = true;
                this.state.simulationInterval = setInterval(() => {
                    this.stepSimulation();
                    
                    // 根据场景控制模拟步数
                    if (this.state.scenario === 'zeroRtt' && this.state.step >= 3) {
                        this.stopSimulation();
                    } else if (this.state.step >= 5) {
                        this.stopSimulation();
                    }
                }, 1500);
            }
            
            stepSimulation() {
                this.state.step++;
                
                switch(this.state.scenario) {
                    case 'zeroRtt':
                        this.simulateZeroRtt();
                        break;
                    case 'multiplexing':
                        this.simulateMultiplexing();
                        break;
                    case 'migration':
                        this.simulateMigration();
                        break;
                    case 'packetLoss':
                        this.simulatePacketLossRecovery();
                        break;
                    case 'congestion':
                        this.simulateCongestionControl();
                        break;
                }
                
                this.renderPackets();
                this.updateProtocolTable();
            }
            
            simulateZeroRtt() {
                switch(this.state.step) {
                    case 1:
                        this.state.clientState = '发送ClientHello';
                        this.state.serverState = '等待连接';
                        this.addPacket({
                            type: 'ClientHello',
                            direction: 'client→server',
                            streamId: 0,
                            encryption: '初始密钥',
                            description: '包含会话凭证和0-RTT数据'
                        });
                        break;
                    case 2:
                        this.state.serverState = '发送ServerHello';
                        this.addPacket({
                            type: 'ServerHello',
                            direction: 'server→client',
                            streamId: 0,
                            encryption: '握手密钥',
                            description: '确认会话恢复，建立1-RTT密钥'
                        });
                        break;
                    case 3:
                        this.state.clientState = '连接就绪';
                        this.state.serverState = '连接就绪';
                        this.addPacket({
                            type: '应用数据',
                            direction: 'client→server',
                            streamId: 1,
                            encryption: '1-RTT密钥',
                            description: '开始传输应用数据'
                        });
                        break;
                }
            }
            
            simulateMultiplexing() {
                if (this.state.step === 1) {
                    this.state.activeStreams = document.getElementById('streamCount').value;
                    this.updateDisplay();
                }
                
                // 模拟多流并行传输
                const streamId = (this.state.step % this.state.activeStreams) + 1;
                this.addPacket({
                    type: 'StreamData',
                    direction: Math.random() > 0.5 ? 'client→server' : 'server→client',
                    streamId: streamId,
                    encryption: '1-RTT密钥',
                    description: `流${streamId}数据传输`
                });
            }
            
            simulateMigration() {
                if (this.state.step === 2) {
                    this.state.connectionId = this.generateConnectionId();
                    this.addPacket({
                        type: 'ConnectionMigration',
                        direction: 'client→server',
                        streamId: '控制帧',
                        encryption: '1-RTT密钥',
                        description: '客户端IP变更，连接迁移'
                    });
                    this.updateDisplay();
                } else {
                    this.addPacket({
                        type: '应用数据',
                        direction: 'client→server',
                        streamId: 1,
                        encryption: '1-RTT密钥',
                        description: `迁移后数据 (CID: ${this.state.connectionId})`
                    });
                }
            }
            
            simulatePacketLossRecovery() {
                if (this.state.step === 3) {
                    this.addPacket({
                        type: '数据包丢失',
                        direction: 'client→server',
                        streamId: 1,
                        encryption: '1-RTT密钥',
                        description: '模拟网络丢包',
                        isLost: true
                    });
                } else if (this.state.step === 4) {
                    this.addPacket({
                        type: 'FEC恢复数据',
                        direction: 'client→server',
                        streamId: 1,
                        encryption: '1-RTT密钥',
                        description: '前向纠错恢复数据'
                    });
                } else {
                    this.addPacket({
                        type: 'StreamData',
                        direction: 'client→server',
                        streamId: 1,
                        encryption: '1-RTT密钥',
                        description: '正常数据传输'
                    });
                }
            }
            
            simulateCongestionControl() {
                const congestionLevel = Math.min(this.state.step, 5);
                this.addPacket({
                    type: '数据包',
                    direction: 'client→server',
                    streamId: 1,
                    encryption: '1-RTT密钥',
                    description: `拥塞控制窗口: ${congestionLevel}/5`
                });
            }
            
            addPacket(packet) {
                packet.timestamp = new Date().toLocaleTimeString();
                packet.id = Date.now();
                this.state.packets.push(packet);
            }
            
            renderPackets() {
                const diagram = document.getElementById('quicDiagram');
                
                // 获取客户端和服务端中心位置
                const clientRect = document.querySelector('.client-box').getBoundingClientRect();
                const serverRect = document.querySelector('.server-box').getBoundingClientRect();
                const diagramRect = diagram.getBoundingClientRect();

                const clientCenter = {
                    x: clientRect.left + clientRect.width - diagramRect.left,
                    y: clientRect.top + clientRect.height/2 - diagramRect.top
                };
                
                const serverCenter = {
                    x: serverRect.left - diagramRect.left,
                    y: serverRect.top + serverRect.height/2 - diagramRect.top
                };

                // 计算每个数据包的垂直位置
                const verticalPositions = [
                    clientCenter.y - 40,  // 上层
                    clientCenter.y,       // 中层
                    clientCenter.y + 40   // 下层
                ];

                // 清除旧的数据包（保留最后3个）
                const existingPackets = diagram.querySelectorAll('.packet');
                if (existingPackets.length > 3) {
                    existingPackets[0].remove();
                }
                
                // 添加新数据包
                const lastPacket = this.state.packets[this.state.packets.length - 1];
                if (!lastPacket) return;
                
                const packetEl = document.createElement('div');
                packetEl.className = `packet ${lastPacket.type.toLowerCase().replace(/\s/g, '-')}`;
                if (lastPacket.isLost) packetEl.classList.add('lost');
                packetEl.textContent = lastPacket.type;
                
                // 设置初始位置
                if (lastPacket.direction.includes('client')) {
                    packetEl.style.left = `${clientCenter.x}px`;
                } else {
                    packetEl.style.left = `${serverCenter.x - 80}px`;
                }
                packetEl.style.top = `${verticalPositions[(this.state.step-1) % 3]}px`;
                
                // 添加数据包信息
                const infoEl = document.createElement('div');
                infoEl.className = 'packet-info';
                infoEl.innerHTML = `
                    <strong>${lastPacket.type}</strong><br>
                    <hr>
                    方向: ${lastPacket.direction}<br>
                    流ID: ${lastPacket.streamId}<br>
                    加密: ${lastPacket.encryption}<br>
                    ${lastPacket.description}
                `;
                packetEl.appendChild(infoEl);
                
                diagram.appendChild(packetEl);
                
                // 动画效果
                setTimeout(() => {
                    if (lastPacket.direction.includes('client')) {
                        packetEl.style.left = `${serverCenter.x - 80}px`;
                    } else {
                        packetEl.style.left = `${clientCenter.x}px`;
                    }
                }, 100);
            }
            
            updateProtocolTable() {
                const tableBody = document.getElementById('protocolTableBody');
                const lastPacket = this.state.packets[this.state.packets.length - 1];
                
                const row = document.createElement('tr');
                if (lastPacket.isLost) row.classList.add('error');
                
                row.innerHTML = `
                    <td>${lastPacket.timestamp}</td>
                    <td>${lastPacket.type}</td>
                    <td>${lastPacket.direction}</td>
                    <td>${lastPacket.streamId}</td>
                    <td>${lastPacket.encryption}</td>
                    <td>客户端: ${this.state.clientState}<br>服务端: ${this.state.serverState}</td>
                    <td>${lastPacket.description}</td>
                `;
                
                tableBody.appendChild(row);
                tableBody.scrollTop = tableBody.scrollHeight;
            }
            
            addStream() {
                if (this.state.activeStreams >= 10) return;
                
                this.state.activeStreams++;
                this.updateDisplay();
                this.updateStreamIndicators(this.state.activeStreams);
                
                this.addPacket({
                    type: 'NewStream',
                    direction: 'client→server',
                    streamId: this.state.activeStreams,
                    encryption: '1-RTT密钥',
                    description: `新建流${this.state.activeStreams}`
                });
                
                this.renderPackets();
                this.updateProtocolTable();
            }
            
            simulatePacketLoss() {
                if (this.state.packets.length === 0) return;
                
                // 随机标记一个数据包为丢失
                const randomIndex = Math.floor(Math.random() * this.state.packets.length);
                this.state.packets[randomIndex].isLost = true;
                
                // 重新渲染以显示丢失状态
                this.resetSimulation();
                this.state.packets.forEach(p => {
                    const packetEl = document.createElement('div');
                    packetEl.className = `packet ${p.type.toLowerCase().replace(/\s/g, '-')}`;
                    if (p.isLost) packetEl.classList.add('lost');
                    packetEl.textContent = p.type;
                    document.getElementById('quicDiagram').appendChild(packetEl);
                });
                
                this.updateProtocolTable();
            }
            
            stopSimulation() {
                if (this.state.simulationInterval) {
                    clearInterval(this.state.simulationInterval);
                    this.state.simulationInterval = null;
                }
                this.state.isSimulating = false;
            }
            
            resetSimulation() {
                this.stopSimulation();
                this.state.step = 0;
                this.state.packets = [];
                this.state.clientState = '新建';
                this.state.serverState = '等待连接';
                
                // 清空可视化
                document.getElementById('quicDiagram').querySelectorAll('.packet').forEach(p => p.remove());
                document.getElementById('protocolTableBody').innerHTML = '';
                
                this.updateDisplay();
            }
        }

        // 初始化模拟器
        const quicSimulator = new QuicSimulator();
        
        // 初始化流指示器
        document.getElementById('streamCount').dispatchEvent(new Event('input'));
    </script>
</body>
</html>